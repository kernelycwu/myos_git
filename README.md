The code is ugly. It is rather dirty, but it works.
